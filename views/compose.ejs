<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compose Email - Bulk Email Sender</title>
  <link rel="stylesheet" href="/css/output.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-pb3VMrR4xY9L+Xqf7x6GkM0JQqM1bS3kqAE+zN0erkK0U5tUhnI7dBDEuDfSUdifYEsaVPLpXwG8rN7xXxF3UQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
</head>
<body class="app-shell">
  
  <!-- Navigation -->
  <nav class="app-nav">
    <div class="app-nav-inner">
      <div class="app-nav-brand">
        <div class="p-2 rounded-lg bg-white/80 border border-slate-200 shadow-sm">
          <i class="fas fa-envelope text-blue-600 text-lg"></i>
        </div>
        <span class="app-nav-title">Bulk Email Sender</span>
      </div>
      
      <div class="hidden md:flex space-x-1">
        <a href="/smtp" class="nav-link">
          <i class="fas fa-server mr-2 text-blue-500"></i>
          <span>SMTP Setup</span>
        </a>
        <a href="/recipients" class="nav-link">
          <i class="fas fa-users mr-2 text-blue-500"></i>
          <span>Recipients</span>
        </a>
        <a href="/compose" class="nav-link nav-link-active">
          <i class="fas fa-pen-nib mr-2 text-blue-500"></i>
          <span>Compose</span>
        </a>
        <a href="/send" class="nav-link">
          <i class="fas fa-paper-plane mr-2 text-blue-500"></i>
          <span>Send</span>
        </a>
      </div>

      <button onclick="clearSession()" class="btn-danger">
        <i class="fas fa-trash-alt mr-2"></i>
        <span>Clear Session</span>
      </button>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="app-main">
    <div class="max-w-6xl mx-auto">
      
      <!-- Page Header -->
      <div class="mb-10">
        <div class="flex items-center mb-4">
          <div class="p-3 bg-white/80 rounded-xl mr-4 border border-slate-200 shadow-sm">
            <i class="fas fa-pen-nib text-blue-600 text-2xl"></i>
          </div>
          <div>
            <h2 class="text-3xl font-bold text-slate-900">Compose email</h2>
            <p class="text-slate-600 mt-1">Create personalized bulk emails using the {{name}} placeholder.</p>
          </div>
        </div>
        
        <div class="flex flex-wrap items-center justify-between gap-4 mt-6 card-glass p-4">
          <div>
            <span class="text-sm text-slate-500">Sending to</span>
            <span class="ml-2 badge-pill">
              <i class="fas fa-user-friends mr-1 text-blue-500"></i>
              <%= recipientCount %> recipients
            </span>
          </div>
          
          <div class="flex items-center text-sm text-slate-600">
            <i class="fas fa-lightbulb text-amber-400 mr-2"></i>
            <span>Use <code class="bg-blue-50 px-2 py-1 rounded border border-blue-200 text-blue-700 font-mono">{{name}}</code> for personalization.</span>
          </div>
        </div>
      </div>

      <!-- Email Composition Card -->
      <div class="card-soft p-8 mb-8">
        
        <!-- Subject Line -->
        <div class="mb-8">
          <label class="block text-slate-800 font-semibold mb-3 flex items-center">
            <i class="fas fa-tag mr-2 text-blue-500"></i>Subject Line
          </label>
          <div class="relative">
            <input 
              type="text" 
              id="emailSubject" 
              class="input-field pl-12 pr-4 py-3.5 text-lg" 
              placeholder="Hello {{name}}, welcome to our newsletter!"
              value="<%= email.subject %>"
            >
            <div class="absolute left-4 top-1/2 transform -translate-y-1/2 text-blue-500">
              <i class="fas fa-heading"></i>
            </div>
          </div>
          <div class="flex items-center mt-3 text-sm text-slate-500">
            <i class="fas fa-info-circle mr-2 text-blue-400"></i>
            Personalize with the <code class="bg-blue-50 px-2 py-1 rounded border border-blue-200 text-blue-700 font-mono mx-1">{{name}}</code> placeholder.
          </div>
        </div>

        <!-- Email Body Section -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <label class="block text-slate-800 font-semibold flex items-center">
              <i class="fas fa-align-left mr-2 text-blue-500"></i>Email Body
            </label>
            
            <div class="flex items-center space-x-2">
              <span class="text-sm text-gray-500 mr-2">View:</span>
              <div class="flex bg-slate-100 rounded-lg p-1">
                <button onclick="toggleView('html')" id="htmlViewBtn" class="view-toggle active px-4 py-2 rounded-md text-sm font-medium bg-blue-600 text-white shadow-sm">
                  <i class="fas fa-code mr-2"></i>HTML
                </button>
                <button onclick="toggleView('preview')" id="previewViewBtn" class="view-toggle px-4 py-2 rounded-md text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-200 transition-all duration-200">
                  <i class="fas fa-eye mr-2"></i>Preview
                </button>
              </div>
            </div>
          </div>

          <!-- Rich Text Toolbar -->
          <div class="mb-4">
            <div class="flex flex-wrap gap-2 p-3 bg-slate-50 rounded-lg border border-slate-200">
              <!-- Formatting -->
              <div class="flex items-center space-x-1 mr-2">
                <span class="text-xs text-slate-500 mr-1">Format:</span>
                <button onclick="formatText('bold')" class="toolbar-btn" title="Bold">
                  <i class="fas fa-bold"></i>
                </button>
                <button onclick="formatText('italic')" class="toolbar-btn" title="Italic">
                  <i class="fas fa-italic"></i>
                </button>
                <button onclick="formatText('underline')" class="toolbar-btn" title="Underline">
                  <i class="fas fa-underline"></i>
                </button>
              </div>

              <!-- Headings -->
              <div class="flex items-center space-x-1 mr-2">
                <span class="text-xs text-slate-500 mr-1">Headings:</span>
                <button onclick="formatText('h1')" class="toolbar-btn" title="Heading 1">
                  H1
                </button>
                <button onclick="formatText('h2')" class="toolbar-btn" title="Heading 2">
                  H2
                </button>
                <button onclick="formatText('h3')" class="toolbar-btn" title="Heading 3">
                  H3
                </button>
              </div>

              <!-- Lists -->
              <div class="flex items-center space-x-1 mr-2">
                <span class="text-xs text-slate-500 mr-1">Lists:</span>
                <button onclick="formatText('ul')" class="toolbar-btn" title="Bullet List">
                  <i class="fas fa-list-ul"></i>
                </button>
                <button onclick="formatText('ol')" class="toolbar-btn" title="Numbered List">
                  <i class="fas fa-list-ol"></i>
                </button>
              </div>

              <!-- Media -->
              <div class="flex items-center space-x-1 mr-2">
                <span class="text-xs text-slate-500 mr-1">Insert:</span>
                <button onclick="insertLink()" class="toolbar-btn" title="Insert Link">
                  <i class="fas fa-link"></i>
                </button>
                <button onclick="insertImage()" class="toolbar-btn" title="Insert Image">
                  <i class="fas fa-image"></i>
                </button>
              </div>

              <!-- Placeholder -->
              <div class="flex items-center space-x-1">
                <button onclick="insertPlaceholder()" class="toolbar-btn bg-blue-50 hover:bg-blue-100 border-blue-200 text-blue-700" title="Insert {{name}} placeholder">
                  <i class="fas fa-user-tag mr-2"></i>{{name}}
                </button>
              </div>

              <!-- Clear -->
              <button onclick="clearEditor()" class="btn-ghost ml-auto px-4 py-2 text-xs">
                <i class="fas fa-eraser mr-2"></i>Clear
              </button>
            </div>
          </div>

          <!-- Email Body Textarea/Preview -->
          <div class="relative">
            <div class="border border-slate-200 rounded-lg overflow-hidden shadow-sm bg-white">
              <textarea 
                id="emailBody" 
                class="w-full px-4 py-4 bg-white text-slate-900 font-mono text-sm focus:outline-none min-h-[300px] resize-y"
                rows="15"
                placeholder="&lt;h1 style='color: #1e40af; font-size: 24px;'&gt;Hello {{name}}!&lt;/h1&gt;
&lt;p style='color: #374151; line-height: 1.6;'&gt;Welcome to our newsletter...&lt;/p&gt;
&lt;p style='color: #374151;'&gt;Best regards,&lt;br&gt;Your Team&lt;/p&gt;"
              ><%= email.body %></textarea>
            </div>

            <div 
              id="emailPreview" 
              class="hidden w-full p-6 bg-white text-slate-900 border border-slate-200 rounded-lg min-h-[300px] overflow-auto shadow-inner"
            ></div>
          </div>

          <!-- Character Counter & Tips -->
          <div class="flex flex-wrap justify-between items-center mt-4">
            <div class="text-sm text-slate-500" id="charCount">
              Characters: <span id="charCountValue" class="font-medium">0</span>
            </div>
            
            <div class="text-sm text-slate-500 flex items-center">
              <i class="fas fa-lightbulb text-blue-400 mr-2"></i>
              <span>You can write HTML directly or use the toolbar buttons</span>
            </div>
          </div>
        </div>

      </div>

      <!-- Action Buttons -->
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4 mt-10">
        <a href="/recipients" class="btn-secondary w-full sm:w-auto flex items-center justify-center">
          <i class="fas fa-arrow-left mr-2"></i>Back to Recipients
        </a>

        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
          <button onclick="previewEmail()" class="btn-secondary w-full sm:w-auto flex items-center justify-center">
            <i class="fas fa-eye mr-2"></i>Preview Email
          </button>
          <button onclick="saveAndContinue()" class="btn-primary w-full sm:w-auto flex items-center justify-center">
            Save & Continue
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>

    </div>
  </main>

  <!-- Preview Modal -->
  <div id="previewModal" class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl border border-blue-200 max-w-5xl w-full max-h-[90vh] overflow-hidden animate-fadeIn">
      
      <!-- Modal Header -->
      <div class="bg-gradient-to-r from-blue-50 to-blue-100 px-6 py-4 border-b border-blue-200 flex justify-between items-center">
        <div class="flex items-center">
          <div class="p-2 bg-white rounded-lg shadow-sm mr-3 border border-blue-200">
            <i class="fas fa-envelope-open-text text-blue-600"></i>
          </div>
          <h3 class="text-xl font-bold text-gray-900">Email Preview</h3>
        </div>
        <button onclick="closePreview()" class="text-gray-500 hover:text-gray-700 text-2xl leading-none p-2 hover:bg-gray-100 rounded-full transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Modal Body -->
      <div class="p-6 overflow-y-auto max-h-[70vh]">
        <div class="mb-6 p-4 bg-blue-50 rounded-xl border border-blue-200">
          <p class="text-sm text-blue-600 mb-1 font-medium">Subject:</p>
          <p class="text-gray-900 font-semibold text-lg" id="previewSubject"></p>
        </div>

        <div class="border border-gray-300 rounded-xl overflow-hidden shadow-inner mb-6">
          <div class="bg-white p-6" id="previewBody">
          </div>
        </div>

        <div class="p-4 bg-blue-50 border border-blue-200 rounded-xl">
          <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
            <div>
              <p class="text-sm text-blue-700 font-medium mb-1">Preview Information</p>
              <p class="text-sm text-gray-600">
                This preview shows how the email will look with the first recipient's name. Each recipient will see their own personalized version.
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex flex-col sm:flex-row justify-between items-center gap-3">
        <div class="text-sm text-blue-600 flex items-center">
          <i class="fas fa-user-friends mr-2"></i>
          Personalization will apply to all <%= recipientCount %> recipients
        </div>
        <div class="flex space-x-3">
          <button onclick="closePreview()" class="btn-ghost flex items-center justify-center px-6 py-3 text-sm">
            <i class="fas fa-times mr-2"></i>Close
          </button>
          <button onclick="closePreviewAndSave()" class="btn-primary flex items-center justify-center px-6 py-3 text-sm">
            <i class="fas fa-check mr-2"></i>Continue to Send
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="app-footer">
    <div class="app-footer-inner">
      <p class="font-medium text-slate-700">Bulk Email Sender Â· Local Gmail SMTP tool</p>
      <p class="mt-1">Recommended limit: 500 emails/day for personal Gmail accounts.</p>
    </div>
  </footer>

  <style>
    /* Animation */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-fadeIn {
      animation: fadeIn 0.2s ease-out;
    }

    /* Placeholder styling in preview */
    .placeholder-highlight {
      background-color: #fef3c7;
      color: #92400e;
      padding: 0.125rem 0.375rem;
      border-radius: 0.25rem;
      font-family: monospace;
      border: 1px solid #f59e0b;
    }
  </style>

  <script>
    if (typeof window !== 'undefined' && window.localStorage) {
      window.localStorage.setItem('bes.currentPage', 'compose');
    }

    let currentView = 'html';
    
    // Initialize character counter
    document.addEventListener('DOMContentLoaded', function() {
      const textarea = document.getElementById('emailBody');
      updateCharCount();
      
      textarea.addEventListener('input', updateCharCount);
      
      // Initialize with example text if empty
      if (!textarea.value.trim()) {
        textarea.value = `<h1 style="color: #1e40af; font-size: 24px; margin-bottom: 16px;">Hello {{name}}!</h1>
<p style="color: #374151; line-height: 1.6; margin-bottom: 12px;">
  Thank you for joining our newsletter! We're excited to have you on board.
</p>
<p style="color: #374151; line-height: 1.6;">
  You'll receive updates, tips, and exclusive content directly in your inbox.
</p>
<p style="color: #374151; margin-top: 20px;">
  Best regards,<br>
  <span style="color: #2563eb; font-weight: bold;">Your Team</span>
</p>`;
        updateCharCount();
      }
    });

    function updateCharCount() {
      const textarea = document.getElementById('emailBody');
      const charCount = textarea.value.length;
      document.getElementById('charCountValue').textContent = charCount;
    }

    function formatText(tag) {
      const textarea = document.getElementById('emailBody');
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const selectedText = textarea.value.substring(start, end);

      if (!selectedText && !['br', 'ul', 'ol'].includes(tag)) {
        alert('Please select text first');
        return;
      }

      let formattedText = '';

      switch(tag) {
        case 'bold':
          formattedText = `<strong>${selectedText}</strong>`;
          break;
        case 'italic':
          formattedText = `<em>${selectedText}</em>`;
          break;
        case 'underline':
          formattedText = `<u>${selectedText}</u>`;
          break;
        case 'h1':
          formattedText = `<h1 style="color: #1e40af; font-size: 24px; font-weight: bold; margin: 0.67em 0;">${selectedText}</h1>`;
          break;
        case 'h2':
          formattedText = `<h2 style="color: #1e40af; font-size: 20px; font-weight: bold; margin: 0.75em 0;">${selectedText}</h2>`;
          break;
        case 'h3':
          formattedText = `<h3 style="color: #1e40af; font-size: 18px; font-weight: bold; margin: 0.83em 0;">${selectedText}</h3>`;
          break;
        case 'p':
          formattedText = `<p style="color: #374151; line-height: 1.6; margin: 1em 0;">${selectedText}</p>`;
          break;
        case 'br':
          formattedText = `<br>`;
          break;
        case 'ul':
          const ulItems = selectedText ? selectedText.split('\n').filter(line => line.trim()).map(line => `  <li style="margin: 0.5em 0; color: #374151;">${line.trim()}</li>`).join('\n') : '  <li style="margin: 0.5em 0; color: #374151;">List item</li>';
          formattedText = `<ul style="margin: 1em 0; padding-left: 2em; list-style-type: disc; color: #374151;">\n${ulItems}\n</ul>`;
          break;
        case 'ol':
          const olItems = selectedText ? selectedText.split('\n').filter(line => line.trim()).map(line => `  <li style="margin: 0.5em 0; color: #374151;">${line.trim()}</li>`).join('\n') : '  <li style="margin: 0.5em 0; color: #374151;">List item</li>';
          formattedText = `<ol style="margin: 1em 0; padding-left: 2em; list-style-type: decimal; color: #374151;">\n${olItems}\n</ol>`;
          break;
      }

      textarea.value = textarea.value.substring(0, start) + formattedText + textarea.value.substring(end);
      textarea.focus();
      textarea.setSelectionRange(start, start + formattedText.length);
      updateCharCount();
    }

    function insertLink() {
      const url = prompt('Enter URL:');
      if (!url) return;

      const text = prompt('Enter link text:') || url;
      const textarea = document.getElementById('emailBody');
      const start = textarea.selectionStart;

      const linkHtml = `<a href="${url}" style="color: #2563eb; text-decoration: underline;">${text}</a>`;
      textarea.value = textarea.value.substring(0, start) + linkHtml + textarea.value.substring(start);
      textarea.focus();
      updateCharCount();
    }

    function insertImage() {
      const url = prompt('Enter image URL:');
      if (!url) return;

      const alt = prompt('Enter image description (alt text):') || 'Image';
      const textarea = document.getElementById('emailBody');
      const start = textarea.selectionStart;

      const imgHtml = `<img src="${url}" alt="${alt}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 1em 0;">`;
      textarea.value = textarea.value.substring(0, start) + imgHtml + textarea.value.substring(start);
      textarea.focus();
      updateCharCount();
    }

    function insertPlaceholder() {
      const textarea = document.getElementById('emailBody');
      const start = textarea.selectionStart;

      textarea.value = textarea.value.substring(0, start) + '{{name}}' + textarea.value.substring(start);
      textarea.focus();
      textarea.setSelectionRange(start + 8, start + 8);
      updateCharCount();
    }

    function clearEditor() {
      if (confirm('Are you sure you want to clear the email body?')) {
        document.getElementById('emailBody').value = '';
        updateCharCount();
      }
    }

    function toggleView(view) {
      const textarea = document.getElementById('emailBody');
      const preview = document.getElementById('emailPreview');
      const htmlBtn = document.getElementById('htmlViewBtn');
      const previewBtn = document.getElementById('previewViewBtn');

      if (view === 'html') {
        textarea.classList.remove('hidden');
        preview.classList.add('hidden');
        htmlBtn.className = 'view-toggle active px-4 py-2 rounded-md text-sm font-medium bg-blue-600 text-white shadow-sm';
        previewBtn.className = 'view-toggle px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-200 transition-all duration-200';
        currentView = 'html';
      } else {
        // Replace placeholders with highlighted version
        const previewHTML = textarea.value.replace(
          /\{\{name\}\}/g, 
          '<span class="placeholder-highlight">{{name}}</span>'
        );
        preview.innerHTML = previewHTML;
        textarea.classList.add('hidden');
        preview.classList.remove('hidden');
        previewBtn.className = 'view-toggle active px-4 py-2 rounded-md text-sm font-medium bg-blue-600 text-white shadow-sm';
        htmlBtn.className = 'view-toggle px-4 py-2 rounded-md text-sm font-medium text-gray-600 hover:text-gray-900 hover:bg-gray-200 transition-all duration-200';
        currentView = 'preview';
      }
    }

    async function previewEmail() {
      const subject = document.getElementById('emailSubject').value;
      const body = document.getElementById('emailBody').value;

      if (!subject || !body) {
        alert('Please enter both subject and body');
        return;
      }

      try {
        const response = await fetch('/compose/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subject, body })
        });

        const result = await response.json();

        if (result.success) {
          // Highlight placeholders in preview
          const highlightedBody = result.body.replace(
            /\{\{name\}\}/g, 
            '<span class="placeholder-highlight">{{name}}</span>'
          );
          
          document.getElementById('previewSubject').textContent = result.subject;
          document.getElementById('previewBody').innerHTML = highlightedBody;
          document.getElementById('previewModal').classList.remove('hidden');
          document.getElementById('previewModal').classList.add('flex');
        }
      } catch (error) {
        alert('Error generating preview: ' + error.message);
      }
    }

    function closePreview() {
      document.getElementById('previewModal').classList.add('hidden');
      document.getElementById('previewModal').classList.remove('flex');
    }

    async function closePreviewAndSave() {
      closePreview();
      await saveAndContinue();
    }

    async function saveAndContinue() {
      const subject = document.getElementById('emailSubject').value;
      const body = document.getElementById('emailBody').value;

      if (!subject || !body) {
        alert('Please enter both subject and body');
        return;
      }

      try {
        const response = await fetch('/compose/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subject, body })
        });

        const result = await response.json();

        if (result.success) {
          window.location.href = '/send';
        } else {
          alert('Failed to save email');
        }
      } catch (error) {
        alert('Error saving email: ' + error.message);
      }
    }

    async function clearSession() {
      if (!confirm('Are you sure you want to clear all session data? This will reset SMTP credentials, recipients, and email content.')) {
        return;
      }

      try {
        const response = await fetch('/session/clear', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
          alert('Session cleared successfully!');
          window.location.href = '/';
        } else {
          alert('Failed to clear session: ' + result.error);
        }
      } catch (error) {
        alert('Error clearing session: ' + error.message);
      }
    }
  </script>
</body>
</html>